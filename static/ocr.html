<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>On-Device OCR Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loader { border-top-color: #3498db; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-8">
    <div class="max-w-4xl mx-auto">
        <header class="mb-8">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-3xl font-bold text-gray-800">ğŸ“· On-Device OCR Manager</h1>
                <div class="flex gap-2">
                    <a href="/" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">Excel Manager</a>
                    <a href="/chatbot.html" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition">Chatbot</a>
                </div>
            </div>
            <p class="text-gray-600">ì´ë¯¸ì§€ í…ìŠ¤íŠ¸ë¥¼ ë¶„ì„í•˜ì—¬ íŒŒì¼ëª…ì„ ìë™ìœ¼ë¡œ ì •ë¦¬í•©ë‹ˆë‹¤.</p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- ë‹¨ì¼ íŒŒì¼ ì²˜ë¦¬ -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <span class="mr-2">ğŸ“„</span> ë‹¨ì¼ íŒŒì¼ ì •ë¦¬
                </h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">ì´ë¯¸ì§€ ì ˆëŒ€ ê²½ë¡œ</label>
                        <input type="text" id="singlePath" placeholder="C:\images\sample.jpg" 
                               class="mt-1 block w-full border border-gray-300 rounded-md p-2 text-sm">
                    </div>
                    <button onclick="processSingle()" id="btnSingle"
                            class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition">
                        ë¶„ì„ ë° ì´ë¦„ ë³€ê²½
                    </button>
                </div>
            </div>

            <!-- ë°°ì¹˜ í´ë” ì²˜ë¦¬ -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <span class="mr-2">ğŸ“</span> í´ë” ì¼ê´„ ì •ë¦¬
                </h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">ëŒ€ìƒ í´ë” ê²½ë¡œ</label>
                        <input type="text" id="folderPath" placeholder="C:\images\batch_folder" 
                               class="mt-1 block w-full border border-gray-300 rounded-md p-2 text-sm">
                    </div>
                    <button onclick="processBatch()" id="btnBatch"
                            class="w-full bg-green-600 text-white py-2 rounded-md hover:bg-green-700 transition">
                        í´ë” ë‚´ ì „ì²´ ì²˜ë¦¬ ì‹œì‘
                    </button>
                </div>
            </div>
        </div>

        <!-- ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ -->
        <div id="previewContainer" class="mt-8 bg-white p-4 rounded-lg shadow-md hidden">
            <h2 class="text-lg font-semibold mb-2 text-gray-700 flex items-center">
                <span class="mr-2">ğŸ–¼ï¸</span> ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
            </h2>
            <div class="flex justify-center bg-gray-50 rounded-lg border-2 border-dashed border-gray-200 p-4">
                <img id="imagePreview" src="" alt="Preview" class="max-h-80 rounded shadow-sm object-contain">
            </div>
        </div>

        <!-- ê²°ê³¼ ë¡œê·¸ ì˜ì—­ -->
        <div class="mt-8 bg-gray-900 rounded-lg p-6 text-green-400 font-mono text-sm h-64 overflow-y-auto shadow-inner" id="logWindow">
            <div>> ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ. ê²½ë¡œë¥¼ ì…ë ¥í•˜ê³  ì‹¤í–‰í•˜ì„¸ìš”...</div>
        </div>
    </div>

    <script>
        const logWindow = document.getElementById('logWindow');

        function addLog(message, type = 'info') {
            const div = document.createElement('div');
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'text-red-400' : (type === 'success' ? 'text-blue-400' : 'text-green-400');
            div.className = `mb-1 ${color}`;
            div.innerHTML = `<span class="text-gray-500">[${time}]</span> ${message}`;
            logWindow.appendChild(div);
            logWindow.scrollTop = logWindow.scrollHeight;
        }

        // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updatePreview(path) {
            const container = document.getElementById('previewContainer');
            const img = document.getElementById('imagePreview');
            
            if (path && (path.toLowerCase().endsWith('.jpg') || path.toLowerCase().endsWith('.jpeg') || path.toLowerCase().endsWith('.png') || path.toLowerCase().endsWith('.bmp'))) {
                img.src = `/chatbot/ocr/image?path=${encodeURIComponent(path)}`;
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        }

        // ì…ë ¥ì°½ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document.getElementById('singlePath').addEventListener('input', (e) => updatePreview(e.target.value));

        async function processSingle() {
            const path = document.getElementById('singlePath').value;
            if (!path) return alert('ê²½ë¡œë¥¼ ì…ë ¥í•˜ì„¸ìš”.');

            addLog(`ë‹¨ì¼ íŒŒì¼ ì²˜ë¦¬ ì‹œì‘: ${path}...`);
            updatePreview(path); // ì²˜ë¦¬ ì‹œì‘ ì‹œ ë¯¸ë¦¬ë³´ê¸° í™•ì¸
            try {
                const response = await fetch('/chatbot/ocr/process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ file_path: path })
                });
                const data = await response.json();
                
                if (response.ok) {
                    addLog(`ì„±ê³µ! ìƒˆ íŒŒì¼ëª…: ${data.filename}`, 'success');
                    // íŒŒì¼ëª…ì´ ë³€ê²½ë˜ì—ˆìœ¼ë¯€ë¡œ ë¯¸ë¦¬ë³´ê¸° ê²½ë¡œ ì—…ë°ì´íŠ¸
                    setTimeout(() => {
                        updatePreview(data.new_path);
                    }, 500);
                } else {
                    addLog(`ì‹¤íŒ¨: ${data.detail}`, 'error');
                }
            } catch (e) {
                addLog(`ì˜¤ë¥˜ ë°œìƒ: ${e.message}`, 'error');
            }
        }

        async function processBatch() {
            const path = document.getElementById('folderPath').value;
            if (!path) return alert('í´ë” ê²½ë¡œë¥¼ ì…ë ¥í•˜ì„¸ìš”.');

            if (!confirm('í´ë” ë‚´ì˜ ëª¨ë“  ì´ë¯¸ì§€ íŒŒì¼ëª…ì´ ë³€ê²½ë©ë‹ˆë‹¤. ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            addLog(`ë°°ì¹˜ ì‘ì—… ìš”ì²­ ì „ì†¡: ${path}...`);
            try {
                const response = await fetch('/chatbot/ocr/batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ folder_path: path })
                });
                const data = await response.json();
                
                if (response.ok) {
                    addLog(`ë°°ì¹˜ ì‘ì—… ì™„ë£Œ! ë¡œê·¸ íŒŒì¼: ${data.log_path}`, 'success');
                } else {
                    addLog(`ì‹¤íŒ¨: ${data.detail}`, 'error');
                }
            } catch (e) {
                addLog(`ì˜¤ë¥˜ ë°œìƒ: ${e.message}`, 'error');
            }
        }
    </script>
</body>
</html>